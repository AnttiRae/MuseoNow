<!DOCTYPE html>
<html>
<head>
    <title>Kartta</title>
    <script type='text/javascript' src='http://getfirebug.com/releases/lite/1.2/firebug-lite-compressed.js'></script>
    <link rel= 'stylesheet' type='text/css' href='main.css'><link>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #mapID {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body onload="init()">
    <div id= 'mapID'></div>
</body>
<script>
    var map;

    function init() {
        map = new L.map('mapID').setView([60.452, 22.278], 12);

        var tiles = 
            L.tileLayer.wms('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',{
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox.streets'
        }).addTo(map)

        var museums = 
        L.tileLayer.wms('https://kartat-mip.turku.fi/geoserver/ows?', {
            layers: 'mip_julkaisut:Paikallismuseot Varsinais-Suomessa kiinteisto',
            transparent: true,
            format: 'image/png'
        });

        museums.addTo(map);

        function Identify(e){
            //Parameters needed for GetFeatureInfo WMS request
            var sw = map.options.crs.project(map.getBounds().getSouthWest());
            var ne = map.options.crs.project(map.getBounds().getNorthEast());
            var BBOX = sw.x + "," + sw.y + "," + ne.x + "," + ne.y;
            var WIDTH = map.getSize().x;
            var HEIGHT = map.getSize().y;

            var X = Math.trunc(map.layerPointToContainerPoint(e.layerPoint).x);
            var Y = Math.trunc(map.layerPointToContainerPoint(e.layerPoint).y);
            
            //URL for request
            var URL = 'https://kartat-mip.turku.fi/geoserver/ows?service=wms&version=1.3.0&REQUEST=GetFeatureInfo&LAYERS=mip_julkaisut:Paikallismuseot%20Varsinais-Suomessa%20kiinteisto&QUERY_LAYERS=mip_julkaisut:Paikallismuseot%20Varsinais-Suomessa%20kiinteisto&BBOX='+BBOX+'&FEATURE_COUNT=1&HEIGHT='+HEIGHT+'&WIDTH='+WIDTH+'&INFO_FORMAT=application%2Fjson&TILED=false&CRS=EPSG%3A3857&I='+X+'&J='+Y;
            console.log(URL);
           
            $.ajax({
                url: URL,
                dataType: "html",
                type: "GET",
                success: function(data) {
                    //if(data.features.lenght !== 0) {
                        console.log("PAKETTI:",data)
                        var returnedFeature = data.features[0];

                        var popup = new L.popup({
                            maxWidth: 300
                        });

                        popup.setContent("<b>"+ returnedFeature.nimi + "</b><b/>"+ returnedFeature.properties.kiinteistotunnus);
                        popup.setLatLng(e.latlng);
                        map.openPopup(popup);
                    //}
                },
                error: function(){
                    console.log("failed")
                }
            });
        }
        map.addEventListener('click', Identify);
    }
</script>
</html>


</script>
</html>